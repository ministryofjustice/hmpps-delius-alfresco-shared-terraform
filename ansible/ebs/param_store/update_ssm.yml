---
- name: set ssm facts
  set_fact:
    new_id: "null"
    snapshot_name: "{{ snapshot_prefix }}_{{ az_name }}"
    ssm_param: "/alfresco/solr/ebs/{{ az_name }}/snapshot_id"

- name: retrieve snapshot id in target account
  ec2_snapshot_info:
    aws_access_key: "{{ aws_access_key_id }}"
    aws_secret_key: "{{ aws_secret_access_key }}"
    security_token: "{{ aws_security_token }}"
    region: "{{ aws_region }}"
    filters:
      "tag:Name": "{{ snapshot_name }}"
  register: refresh_snapshot

- name: get snapshot id from ssm
  set_fact:
    snapshot_id: "{{ lookup('aws_ssm', ssm_param, aws_access_key=aws_access_key_id, aws_secret_key=aws_secret_access_key, aws_security_token=aws_security_token ) or '' }}"

- name: set new snapshot fact
  set_fact:
    new_id: "{{ refresh_snapshot.snapshots[0].snapshot_id }}"
  when: refresh_snapshot.snapshots != []

- name: Create snapshot param entry
  aws_ssm_parameter_store:
    name: "{{ ssm_param }}"
    description: "Used for Solr EBS volume refresh"
    string_type: "String"
    value: "{{ new_id }}"
    overwrite_value: "always"
    aws_access_key: "{{ aws_access_key_id }}"
    aws_secret_key: "{{ aws_secret_access_key }}"
    security_token: "{{ aws_security_token }}"
    region: "{{ aws_region }}"
  when: new_id != snapshot_id

- name: Return snapshot id
  debug:
    msg: "{{ new_id }}"
