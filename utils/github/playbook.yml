---
- name: Create new release
  hosts: localhost
  gather_facts: no
  connection: local
  vars:
    github_user: "{{ lookup('env', 'GITHUB_USER') }}"
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"
    git_commit_hash: "{{ lookup('env', 'CODEBUILD_RESOLVED_SOURCE_VERSION') }}"
    github_org: "{{ lookup('env', 'GITHUB_ORG') }}" 
    target_branch: "{{ lookup('env', 'TARGET_BRANCH') }}"
    github_repo: "{{ lookup('env', 'GITHUB_REPO') }}"
    environment_name: "{{ lookup('env', 'ENVIRONMENT_NAME') }}"
  tasks:
    - name: "Create release for {{ environment_name }}"
      github_release:
        token: "{{ github_token }}"
        user: "{{ github_org }}"
        repo: "{{ github_repo }}"
        action: create_release
        tag: "{{ environment_name }}"
        target: "{{ target_branch }}"
        name: "auto-generated-{{ environment_name }}" 
        body: "Target environment {{ environment_name }}"
      no_log: true
